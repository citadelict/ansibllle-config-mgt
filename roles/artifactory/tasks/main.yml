# ---
# # tasks file for installing Artifactory

# - name: Change hostname to Artifactory
#   ansible.builtin.hostname:
#     name: Artifactory

# - name: Update /etc/hosts with the new hostname
#   ansible.builtin.lineinfile:
#     path: /etc/hosts
#     regexp: '^127\.0\.1\.1\s+.*'
#     line: '127.0.1.1 Artifactory'
#     state: present

- name: Install required packages
  ansible.builtin.apt:
    name:
      - apt-transport-https
      - ca-certificates
      - curl
      - gpg
    state: latest

- name: Remove conflicting JFrog repository if it exists
  ansible.builtin.apt_repository:
    repo: "deb [signed-by=/usr/share/keyrings/jfrog-archive-keyring.gpg] https://releases.jfrog.io/artifactory/artifactory-debs bionic main"
    state: absent
  ignore_errors: true

- name: Remove any existing key file
  ansible.builtin.file:
    path: "/usr/share/keyrings/jfrog-archive-keyring.gpg"
    state: absent
  ignore_errors: true

- name: Remove the JFrog repository list if exists
  ansible.builtin.file:
    path: "/etc/apt/sources.list.d/artifactory.list"
    state: absent
  ignore_errors: true

- name: Download apt key
  ansible.builtin.get_url:
    url: "https://releases.jfrog.io/artifactory/api/gpg/key/public"
    dest: "/usr/share/keyrings/artifactory-apt-keyring.asc"
    mode: "0644"

- name: Add JFrog Artifactory APT repository
  ansible.builtin.apt_repository:
    repo: "deb [signed-by=/usr/share/keyrings/artifactory-apt-keyring.asc] https://releases.jfrog.io/artifactory/artifactory-debs bionic main"
    state: present

- name: Update the package list
  ansible.builtin.apt:
    update_cache: yes

- name: Install Artifactory
  ansible.builtin.apt:
    name: jfrog-artifactory-oss
    state: present

- name: Start Artifactory service
  ansible.builtin.systemd:
    name: artifactory.service
    state: started

- name: Enable Artifactory service
  ansible.builtin.systemd:
    name: artifactory.service
    enabled: yes

- name: Check Artifactory service status
  ansible.builtin.systemd:
    name: artifactory.service
    register: artifactory_status

- name: Ensure Artifactory is running
  ansible.builtin.debug:
    msg: "Artifactory is installed and running"
  when: artifactory_status.status.ActiveState == "active"
